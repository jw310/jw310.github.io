<!DOCTYPE html><html lang="zh-TW" data-theme="light"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>Node.js 實作登入及驗證 | Jw的學習大小事</title><meta name="description" content="Node.js 實作登入及驗證"><meta name="keywords" content="Nodejs,Passportjs"><meta name="author" content="jerry wu"><meta name="copyright" content="jerry wu"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Node.js 實作登入及驗證"><meta name="twitter:description" content="Node.js 實作登入及驗證"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta property="og:type" content="article"><meta property="og:title" content="Node.js 實作登入及驗證"><meta property="og:url" content="https://jw310.github.io/2020/05/06/nodejs-login-auth/"><meta property="og:site_name" content="Jw的學習大小事"><meta property="og:description" content="Node.js 實作登入及驗證"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://jw310.github.io/2020/05/06/nodejs-login-auth/"><link rel="prev" title="關於 Cookie 與 Session" href="https://jw310.github.io/2020/05/06/cookie-session/"><link rel="next" title="處理 vue eslint 錯誤(分號、雙引號、函式空格)" href="https://jw310.github.io/2020/04/20/vue-eslint-quotes-error/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '複製成功',
    error: '複製錯誤',
    noSupport: '瀏覽器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '鍵將本頁加入書籤'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Jw的學習大小事</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.gif" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">28</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">標籤</div><div class="length_num">34</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分類</div><div class="length_num">22</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目錄</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#Node-js-實作登入及驗證"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">Node.js 實作登入及驗證</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#Passport-js"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">Passport.js</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#安裝載入模組"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">安裝載入模組</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#建立驗證策略及序列化與反序列化的函式"><span class="toc_mobile_items-number">2.2.</span> <span class="toc_mobile_items-text">建立驗證策略及序列化與反序列化的函式</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#建立驗證策略機制"><span class="toc_mobile_items-number">2.2.1.</span> <span class="toc_mobile_items-text">建立驗證策略機制</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#序列化與反序列化"><span class="toc_mobile_items-number">2.2.2.</span> <span class="toc_mobile_items-text">序列化與反序列化</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#建立驗證路由"><span class="toc_mobile_items-number">2.3.</span> <span class="toc_mobile_items-text">建立驗證路由</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#建立-req-isAuthenticated"><span class="toc_mobile_items-number">2.4.</span> <span class="toc_mobile_items-text">建立 req.isAuthenticated()</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#驗證完成後續的請求過程"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">驗證完成後續的請求過程</span></a></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目錄</div><div class="sidebar-toc__progress"><span class="progress-notice">你已經讀了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Node-js-實作登入及驗證"><span class="toc-number">1.</span> <span class="toc-text">Node.js 實作登入及驗證</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Passport-js"><span class="toc-number">2.</span> <span class="toc-text">Passport.js</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#安裝載入模組"><span class="toc-number">2.1.</span> <span class="toc-text">安裝載入模組</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#建立驗證策略及序列化與反序列化的函式"><span class="toc-number">2.2.</span> <span class="toc-text">建立驗證策略及序列化與反序列化的函式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#建立驗證策略機制"><span class="toc-number">2.2.1.</span> <span class="toc-text">建立驗證策略機制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#序列化與反序列化"><span class="toc-number">2.2.2.</span> <span class="toc-text">序列化與反序列化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#建立驗證路由"><span class="toc-number">2.3.</span> <span class="toc-text">建立驗證路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#建立-req-isAuthenticated"><span class="toc-number">2.4.</span> <span class="toc-text">建立 req.isAuthenticated()</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#驗證完成後續的請求過程"><span class="toc-number">3.</span> <span class="toc-text">驗證完成後續的請求過程</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)"><div id="post-info"><div id="post-title"><div class="posttitle">Node.js 實作登入及驗證</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 發表於 2020-05-06<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新於 2020-05-06</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Nodejs/">Nodejs</a></span><div class="post-meta-wordcount"><i class="fa fa-file-word-o post-meta__icon fa-fw" aria-hidden="true"></i><span>字數總計:</span><span class="word-count">3.1k</span><span class="post-meta__separator">|</span><i class="fa fa-clock-o post-meta__icon fa-fw" aria-hidden="true"></i><span>閲讀時長: 13 分鐘</span><div class="post-meta-pv-cv"><span class="post-meta__separator">|</span><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>閲讀量:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="Node-js-實作登入及驗證"><a href="#Node-js-實作登入及驗證" class="headerlink" title="Node.js 實作登入及驗證"></a>Node.js 實作登入及驗證</h1><p>接續 <a href="https://jw310.github.io/2020/04/15/nodejs-mongodb-restfulapi/#RESTful-API">使用 Node.js 與 RESTful API 架構來串接 mongoDB 並部署到 Heroku</a> 的內容來修改並加入登入及驗證的功能。 </p>
<p>這裡會專注在登入驗證的部分，使用 Passport.js 來處理。程式會分成：驗證(verification)、路由(routes)、邏輯控制(controllers)來處理，方便管理及修改。</p>
<h1 id="Passport-js"><a href="#Passport-js" class="headerlink" title="Passport.js"></a>Passport.js</h1><p>Passport 可以想成是一個處理驗證的 middleware，提供超過上百組驗證策略(Strategy)。可以依照自己的需求，使用帳號和密碼或第三方認證系統，如 Facebook、Google…等等。在這我們使用本地驗證 LocalStrategy(帳號和密碼)。</p>
<p>使用上大致分成幾個部分：</p>
<h2 id="安裝載入模組"><a href="#安裝載入模組" class="headerlink" title="安裝載入模組"></a>安裝載入模組</h2><p><code>npm install passport passport-local --save</code></p>
<p>app.js</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// 引用 express</span><br><span class="line">const express = require(&apos;express&apos;)</span><br><span class="line">const app = express()</span><br><span class="line">// 身份認證</span><br><span class="line">const passport = require(&apos;passport&apos;)</span><br><span class="line">const session = require(&apos;express-session&apos;)</span><br><span class="line">app.use(session(&#123;</span><br><span class="line">    secret: &apos;secretok&apos;,</span><br><span class="line">    // 強制將未初始化的session存回 session store</span><br><span class="line">    saveUninitialized: false,</span><br><span class="line">    // 強制將session存回 session store,</span><br><span class="line">    resave: false,</span><br><span class="line">&#125;))</span><br><span class="line">// passport.user 初始化</span><br><span class="line">app.use(passport.initialize())</span><br><span class="line">// 處理 Session，呼叫 deserializeUser()。若有找到 req.user，則判定其通過驗證。</span><br><span class="line">app.use(passport.session())</span><br></pre></td></tr></table></figure></div>
<p>ps. session() 需設定在 passport.session() 之前，以確保 session 能正確地被處理</p>
<h2 id="建立驗證策略及序列化與反序列化的函式"><a href="#建立驗證策略及序列化與反序列化的函式" class="headerlink" title="建立驗證策略及序列化與反序列化的函式"></a>建立驗證策略及序列化與反序列化的函式</h2><p>在 web 應用中，驗證訊息(credentials)，只在登入時被傳送，驗證成功後，會記錄在 session 並儲存 cookies 在瀏覽器內。之後的 request 都不會再帶驗證訊息，而是透過 cookie 來辨認 session，為了支援 login sessions，在 Passport 中會序列化（serialize）和反序列化（deserialize）在 session 中的使用者實例。</p>
<p>ps.序列化(serialize)簡單說就是把 <code>物件</code>轉換成可被儲存在儲存空間的<code>資料</code>的這個過程，例如把 JavaScript 中的物件透過 JSON.stringify() 變成字串儲存。而反序列化則是倒過來把<code>資料</code>轉換成程式碼中的<code>物件</code>，例如把 JSON 字串透過 JSON.parse() 轉換成物件。</p>
<h3 id="建立驗證策略機制"><a href="#建立驗證策略機制" class="headerlink" title="建立驗證策略機制"></a>建立驗證策略機制</h3><ul>
<li>引用 passport 及 策略</li>
<li>passport.use() 建立策略</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const passport = require(&apos;passport&apos;)</span><br><span class="line">const LocalStrategy = require(&apos;passport-local&apos;).Strategy</span><br><span class="line"></span><br><span class="line">passport.use(new LocalStrategy(</span><br><span class="line">  	// 驗證 code .....</span><br><span class="line">  ))</span><br></pre></td></tr></table></figure></div>
<ul>
<li>設定完 Strategy 後，要加上 Verify Callback</li>
<li>Verify Callback 帶入 username, password 參數，進行驗證</li>
<li>完成驗證後，呼叫 done，帶入驗證後結果</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">passport.use(new LocalStrategy(</span><br><span class="line">	 // Verify Callback 驗證時，呼叫此函式</span><br><span class="line">  	 function(username, password, done) &#123;</span><br><span class="line">    // 驗證 code...</span><br><span class="line">  &#125;</span><br><span class="line">  ))</span><br></pre></td></tr></table></figure></div>
<ul>
<li>使用 LocalStrategy 時，預設從 req.body 中的 username 和 password 的欄位取得資料。若要使用其他欄位，並使用 req 物件時，例如：使用 req.flash() 設定時，可加上 options(非必要)。</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">passport.use(new LocalStrategy(</span><br><span class="line">  &#123;</span><br><span class="line">    // 改用 email 的欄位作為帳號</span><br><span class="line">    usernameField: &apos;email&apos;,</span><br><span class="line">    // 改用 userpassword 的欄位作為密碼</span><br><span class="line">    passwordField: &apos;userpassword&apos;</span><br><span class="line">    // 讓 varify callback 函式可以取得 req 物件</span><br><span class="line">    passReqToCallback: true </span><br><span class="line">  &#125;,</span><br><span class="line">  // 新增 req 引數</span><br><span class="line">  function(req, email, userpassword, done) &#123;</span><br><span class="line">  // 驗證 code...</span><br><span class="line">  &#125;</span><br><span class="line">))</span><br></pre></td></tr></table></figure></div>
<ul>
<li>done 是 callback function，驗證完成後，呼叫 done 並將驗證結果作為參數傳入，提供給 Passport 使用。  </li>
<li>done 接收三種參數：<br>1.錯誤訊息：伺服器端回傳錯誤訊息時，帶入錯誤訊息 err；無錯誤訊息時，則可以帶入 null 取代<br>2.使用者資料：驗證成功時，帶入使用者資料 user；驗證失敗時，則可以帶入 false 取代<br>3.驗證失敗訊息：當驗證失敗時，可以額外補充驗證失敗的原因和資訊</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 驗證成功時，提供 Passport 該名使用者資料</span><br><span class="line">return done(null, user)</span><br><span class="line"></span><br><span class="line">// 驗證失敗時，不提供 Passport 任何使用者資料</span><br><span class="line">return done(null, false)</span><br><span class="line"></span><br><span class="line">// 驗證失敗時，不提供 Passport 任何使用者資料，但告知失敗原因</span><br><span class="line">return done(null, false, &#123; message: &apos;Incorrect password.&apos; &#125;)</span><br><span class="line"></span><br><span class="line">// 當伺服器端產生錯誤訊息時，提供 Passport 錯誤訊息內容</span><br><span class="line">return done(err)</span><br></pre></td></tr></table></figure></div>
<p>e.g. 完整驗證策略</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">const passport = require(&apos;passport&apos;)</span><br><span class="line">const LocalStrategy = require(&apos;passport-local&apos;).Strategy</span><br><span class="line"></span><br><span class="line">// 透過 passport.use() 建立驗證機制</span><br><span class="line">passport.use(new LocalStrategy(&#123;</span><br><span class="line">        // 改以名為 email 的欄位資訊作為帳號</span><br><span class="line">        // usernameField: &apos;email&apos;,</span><br><span class="line">        // 改以名為 passwd 的欄位資訊作為密碼</span><br><span class="line">        // passwordField: &apos;passwd&apos;,</span><br><span class="line">        // 讓 varify callback 函式可以取得 req 物件</span><br><span class="line">        passReqToCallback: true</span><br><span class="line">    &#125;,</span><br><span class="line">        // 當請 passport 要驗證時，呼叫此 callback 函式，並帶入驗證資訊驗證</span><br><span class="line">        // Varify Callback: 新增 req 引數</span><br><span class="line">        function (req, username, password, done) &#123;</span><br><span class="line">            // console.log(username, password)</span><br><span class="line">            // 從 MongoDB 查詢使用者</span><br><span class="line">            db.collection(&apos;users&apos;).findOne(&#123; username: username &#125;, function (err, user) &#123;</span><br><span class="line">                // console.log(user)</span><br><span class="line">                // 如果伺服器端回傳錯誤訊息，提供 passport 錯誤訊息</span><br><span class="line">                if (err) &#123; return done(err) &#125;</span><br><span class="line">                // 如果沒有在資料庫裡找到該位使用者，不提供 passport 任何使用者資訊，告知失敗原因，並將錯誤資訊放內 flash() 內</span><br><span class="line">                if (!user) &#123; return done(null, false, req.flash(&apos;info&apos;, &apos;User not found.&apos;)) &#125;</span><br><span class="line">                // 驗證密碼</span><br><span class="line">                bcrypt.compare(password, user.password, (err, isMatch) =&gt; &#123;</span><br><span class="line">                    // password correct</span><br><span class="line">                    if (isMatch) &#123; return done(null, user) &#125;</span><br><span class="line">                    // 如果從資料庫找到了該名使用者，但密碼錯誤時，不提供 passport 任何使用者資訊，告知失敗原因</span><br><span class="line">                    return done(null, false, req.flash(&apos;info&apos;, &apos;Invalid password&apos;))</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    ))</span><br></pre></td></tr></table></figure></div>
<h3 id="序列化與反序列化"><a href="#序列化與反序列化" class="headerlink" title="序列化與反序列化"></a>序列化與反序列化</h3><p>passport.serializeUser()</p>
<ul>
<li>從 strategy 得到參數值 user，可設定將哪些 user 資訊，儲存在 Session 中的 req.session.passport.user</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">passport.serializeUser(function(user, done) &#123;</span><br><span class="line">  // 只將用戶 id 序列化存到 session 中</span><br><span class="line">  done(null, user.id)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></div>
<p>passport.deserializeUser()</p>
<ul>
<li>從 session 中取得 user (req.session.passport.user) 值，透過該資訊至資料庫找到完整的用戶資料，儲存在 req.user</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">passport.deserializeUser(function(id, done) &#123;</span><br><span class="line">  //  為了讓 session 小一點，透過使用者 id 到資料庫尋找用戶完整資訊</span><br><span class="line">  User.findById(id, function(err, user) &#123;</span><br><span class="line">    done(err, user)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></div>
<p>將驗證策略及序列化與反序列化的函式整合後，再引入 app.js 使用  </p>
<p>./verification/passport.js</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">// 用帳密來做驗證</span><br><span class="line">const LocalStrategy = require(&apos;passport-local&apos;).Strategy</span><br><span class="line">const FacebookStrategy = require(&apos;passport-facebook&apos;).Strategy</span><br><span class="line">const GoogleStrategy = require(&apos;passport-google-oauth20&apos;).Strategy</span><br><span class="line">const mongoose = require(&apos;mongoose&apos;)</span><br><span class="line">const db = require(&apos;../connections/mongoDB_connect&apos;)</span><br><span class="line">// 加解密</span><br><span class="line">const bcrypt = require(&apos;bcryptjs&apos;)</span><br><span class="line">//</span><br><span class="line">const ObjectID = require(&apos;mongodb&apos;).ObjectID</span><br><span class="line"></span><br><span class="line">module.exports = passport =&gt; &#123;</span><br><span class="line">    // local strategy</span><br><span class="line">    // 透過 passport.use() 建立驗證機制</span><br><span class="line">    passport.use(new LocalStrategy(&#123;</span><br><span class="line">        // 改以名為 email 的欄位資訊作為帳號</span><br><span class="line">        // usernameField: &apos;email&apos;,</span><br><span class="line">        // 改以名為 passwd 的欄位資訊作為密碼</span><br><span class="line">        // passwordField: &apos;passwd&apos;,</span><br><span class="line">        // 讓 varify callback 函式可以取得 req 物件</span><br><span class="line">        passReqToCallback: true</span><br><span class="line">    &#125;,</span><br><span class="line">        // 當請 passport 要驗證時，呼叫此 callback 函式，並帶入驗證資訊驗證</span><br><span class="line">        // Varify Callback: 新增 req 引數</span><br><span class="line">        function (req, username, password, done) &#123;</span><br><span class="line">            // console.log(username, password)</span><br><span class="line">            // 從 MongoDB 查詢使用者</span><br><span class="line">            db.collection(&apos;users&apos;).findOne(&#123; username: username &#125;, function (err, user) &#123;</span><br><span class="line">                // console.log(user)</span><br><span class="line">                // 如果伺服器端回傳錯誤訊息，提供 passport 錯誤訊息</span><br><span class="line">                if (err) &#123; return done(err) &#125;</span><br><span class="line">                // 如果沒有在資料庫裡找到該位使用者，不提供 passport 任何使用者資訊，告知失敗原因，並將錯誤資訊放內 flash() 內</span><br><span class="line">                if (!user) &#123; return done(null, false, req.flash(&apos;info&apos;, &apos;User not found.&apos;)) &#125;</span><br><span class="line">                // 驗證密碼</span><br><span class="line">                bcrypt.compare(password, user.password, (err, isMatch) =&gt; &#123;</span><br><span class="line">                    // password correct</span><br><span class="line">                    if (isMatch) &#123; return done(null, user) &#125;</span><br><span class="line">                    // 如果從資料庫找到了該名使用者，但密碼錯誤時，不提供 passport 任何使用者資訊，告知失敗原因</span><br><span class="line">                    return done(null, false, req.flash(&apos;info&apos;, &apos;Invalid password&apos;))</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    ))</span><br><span class="line"></span><br><span class="line">    // 從 strategy 得到輸入值 user，可設定將哪些 user 資訊，儲存在 Session 中的 req.session.passport.user</span><br><span class="line">    passport.serializeUser(function (user, done) &#123;</span><br><span class="line">        // 只將用戶 id 序列化存到 session 中，mongoDB 的 id 欄位為 _id</span><br><span class="line">        done(null, user)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 輸入 user (req.session.passport.user) 值，從 session 中取得該資料，儲存在 req.user</span><br><span class="line">    passport.deserializeUser(function (user, done) &#123;</span><br><span class="line">        // 為了讓session小一點，透過使用者 id 到 MongoDB 資料庫尋找用戶完整資訊</span><br><span class="line">        // const objid = &#123; _id: ObjectID(id) &#125;</span><br><span class="line">        // db.collection(&apos;users&apos;).findById(id, function (err, user) &#123;</span><br><span class="line">        //     done(err, user)</span><br><span class="line">        //     // console.log(req.user)</span><br><span class="line">        // &#125;)</span><br><span class="line">        done(null, user)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>app.js</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require(&apos;./verification/passport&apos;)(passport)</span><br></pre></td></tr></table></figure></div>
<h2 id="建立驗證路由"><a href="#建立驗證路由" class="headerlink" title="建立驗證路由"></a>建立驗證路由</h2><p>加上 passport.authenticate() middleware 驗證使用者是否認證。</p>
<ul>
<li>路由基本使用</li>
<li>加上使用的策略</li>
<li>及成功或失敗，各自導向的頁面</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.post(&apos;/login&apos;, passport.authenticate(&apos;local&apos;, &#123;</span><br><span class="line">  successRedirect: &apos;/&apos;,</span><br><span class="line">  failureRedirect: &apos;/users/login&apos;</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure></div>
<ul>
<li>改寫成驗證成功後，先執行 function()。再導向頁面</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.post(&apos;/login&apos;, </span><br><span class="line">  passport.authenticate(&apos;local&apos;, &#123; failureRedirect: &apos;/login&apos; &#125;),</span><br><span class="line">  // 驗證成功時，呼叫函式，且 req.user 帶有該使用者資訊</span><br><span class="line">  function(req, res) &#123;</span><br><span class="line">    // 想執行的動作</span><br><span class="line">    res.redirect(&apos;/&apos;)</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></div>
<ul>
<li>如果內建的驗證請求不符合使用，可以客制化 callback 來處理</li>
<li><code>passport.authenticate(&#39;&lt;strategyName&gt;&#39;, callback&lt;err, user, info&gt;)</code></li>
<li>這範例，是在 Express 中的路由中去執行，而不是當 middleware 使用。因此這是使用 closure 來在 callback 中取得 req 和 res。如果認證失敗，user 會被設成 false；如果例外發生；err 會被設定；info 則可以拿到 strategy 中 verify callback 所提供的更多訊息</li>
<li>要注意的地方是，使用客制化的 callback 時，需要透過 req.logIn(‘user’, callback<err>) 來建立 session，並且回傳 response。若使用者登入成功，user 會被指定到 req.user。req.logout() 則會移除 req.user 這個屬性，並同時清除 login session(若有的話)</err></li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">app.post(&apos;/login&apos;, &#123;</span><br><span class="line">passport.authenticate(&apos;local&apos;, function (err, user, info) &#123;</span><br><span class="line">            if (err) &#123; return next(err); &#125;</span><br><span class="line">            if (!user) &#123;</span><br><span class="line">                return res.status(200).send(&#123;</span><br><span class="line">                    success: false,</span><br><span class="line">                    message: &quot;帳密錯誤&quot;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            req.logIn(user, function (err) &#123;</span><br><span class="line">                if (err) &#123; return next(err); &#125;</span><br><span class="line">                return res.status(200).send(&#123;</span><br><span class="line">                    success: true,</span><br><span class="line">                    message: &quot;登入成功&quot;,</span><br><span class="line">                    uid: &apos;&apos;,</span><br><span class="line">                &#125;)</span><br><span class="line">                // res.redirect(&apos;/&apos;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;)(req, res, next);</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure></div>
<p>這裡是將 passport.authenticate() 寫在邏輯控制，再給路由引用。</p>
<p>./controllers/user.js</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">// 引用 express</span><br><span class="line">const express = require(&apos;express&apos;)</span><br><span class="line">const router = express()</span><br><span class="line">// 登入驗證</span><br><span class="line">const passport = require(&apos;passport&apos;);</span><br><span class="line">// 連接 mongoDB</span><br><span class="line">const db = require(&apos;../connections/mongoDB_connect&apos;)</span><br><span class="line">// 加解密</span><br><span class="line">const bcrypt = require(&apos;bcryptjs&apos;)</span><br><span class="line">// 查詢條件是 id 時，要轉換成 objectID</span><br><span class="line">const ObjectID = require(&apos;mongodb&apos;).ObjectID</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">    getLogin: (req, res) =&gt; &#123;</span><br><span class="line">        res.render(&apos;login&apos;, &#123;</span><br><span class="line">            error: req.flash(&apos;info&apos;)</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    postLogin: function (req, res, next) &#123;</span><br><span class="line">        passport.authenticate(&apos;local&apos;, function (err, user, info) &#123;</span><br><span class="line">            if (err) &#123; return next(err); &#125;</span><br><span class="line">            if (!user) &#123;</span><br><span class="line">                return res.status(200).send(&#123;</span><br><span class="line">                    success: false,</span><br><span class="line">                    message: &quot;帳密錯誤&quot;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            req.logIn(user, function (err) &#123;</span><br><span class="line">                if (err) &#123; return next(err); &#125;</span><br><span class="line">                return res.status(200).send(&#123;</span><br><span class="line">                    success: true,</span><br><span class="line">                    message: &quot;登入成功&quot;,</span><br><span class="line">                    uid: &apos;&apos;,</span><br><span class="line">                &#125;)</span><br><span class="line">                // res.redirect(&apos;/&apos;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;)(req, res, next);</span><br><span class="line">    &#125;,</span><br><span class="line">    getLogout: function (req, res) &#123;</span><br><span class="line">        req.logOut()</span><br><span class="line">        req.session.destroy(() =&gt; &#123;</span><br><span class="line">            res.clearCookie(&apos;connect.sid&apos;)</span><br><span class="line">            res.status(200).send(&#123;</span><br><span class="line">                success: true,</span><br><span class="line">                message: &apos;已登出&apos;</span><br><span class="line">            &#125;)</span><br><span class="line">            // res.redirect(&apos;/&apos;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>./routes/user.js</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">const express = require(&apos;express&apos;);</span><br><span class="line">const router = express.Router();</span><br><span class="line">// Include user controller method 解構賦值來使用</span><br><span class="line">const &#123; getLogin, postLogin, getSignup, postSignup, getUserInfo, getLogout &#125; = require(&apos;../controllers/user&apos;)</span><br><span class="line">// 驗證是否已登入，需驗證的頁面使用</span><br><span class="line">const &#123; authenticated &#125; = require(&apos;../verification/auth&apos;)</span><br><span class="line"></span><br><span class="line">router.get(&apos;/login&apos;, getLogin)</span><br><span class="line"></span><br><span class="line">router.post(&apos;/login&apos;, postLogin)</span><br><span class="line"></span><br><span class="line">router.get(&apos;/signup&apos;, getSignup)</span><br><span class="line"></span><br><span class="line">router.post(&apos;/signup&apos;, postSignup)</span><br><span class="line"></span><br><span class="line">router.get(&apos;/userinfo&apos;, authenticated, getUserInfo)</span><br><span class="line"></span><br><span class="line">router.get(&apos;/logout&apos;, getLogout)</span><br><span class="line"></span><br><span class="line">module.exports = router;</span><br></pre></td></tr></table></figure></div>
<h2 id="建立-req-isAuthenticated"><a href="#建立-req-isAuthenticated" class="headerlink" title="建立 req.isAuthenticated()"></a>建立 req.isAuthenticated()</h2><p>在 req 物件上可以使用的 passport method，可以拿來做 middleware，來確認使用者是否通過驗證的狀態，獲得瀏覽該頁面的權限。</p>
<p>./verification/auth.js</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">    authenticated: (req, res, next) =&gt; &#123;</span><br><span class="line">        if (req.isAuthenticated()) &#123; return next() &#125;</span><br><span class="line">        req.flash(&apos;warning_msg&apos;, &apos;請先登入才能此用&apos;)</span><br><span class="line">        res.redirect(&apos;/user/login&apos;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>使用：</p>
<p>./routes/user.js</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 驗證是否已登入，需驗證的頁面使用</span><br><span class="line">const &#123; authenticated &#125; = require(&apos;../verification/auth&apos;)</span><br><span class="line"></span><br><span class="line">//前往 /userinfo 時，驗證身份後才執行 getUserInfo() 渲染頁面</span><br><span class="line">router.get(&apos;/userinfo&apos;, authenticated, getUserInfo)</span><br></pre></td></tr></table></figure></div>
<h1 id="驗證完成後續的請求過程"><a href="#驗證完成後續的請求過程" class="headerlink" title="驗證完成後續的請求過程"></a>驗證完成後續的請求過程</h1><ol>
<li>Session 機制會在一個用戶完成身分認證後，存下所需的用戶資料，接著產生一組對應的對應的 id，存入 cookie 後傳回用戶端。</li>
<li>客戶端產生請求，透過 cookie 上的 session id 至 session 中取得被序列化的用戶資訊，存放到 req.session.passport.user。</li>
<li>passport.initialize() 被觸發：確認 passport.user 上有被序列化的使用者物件，若物件不存在，則創建一個空物件。</li>
<li>passport.session() 被觸發：若有找到被序列化的使用者物件，則判定此請求的用戶是已經通過驗證的狀態。</li>
<li>passport.session() 呼叫 deserializeUser() — 透過用戶 資料前往資料庫找到使用者完整資料，放置在 req.user 上供往後使用。</li>
</ol>
<a href="/2020/05/06/nodejs-login-auth/passport.png" data-fancybox="group" data-caption="undefined" class="fancybox"><img src="/2020/05/06/nodejs-login-auth/passport.png" title="This is an image"></a>
<p>參考：<br><a href="https://ithelp.ithome.com.tw/articles/10228464?sc=rss.iron" target="_blank" rel="noopener">https://ithelp.ithome.com.tw/articles/10228464?sc=rss.iron</a><br><a href="https://pjchender.github.io/2017/09/26/node-passport-學習筆記（learn-to-use-passport-js）/" target="_blank" rel="noopener">https://pjchender.github.io/2017/09/26/node-passport-學習筆記（learn-to-use-passport-js）/</a><br><a href="https://medium.com/麥克的半路出家筆記/筆記-透過-passport-js-實作驗證機制-11cf478f421e" target="_blank" rel="noopener">https://medium.com/麥克的半路出家筆記/筆記-透過-passport-js-實作驗證機制-11cf478f421e</a><br><a href="https://andyyou.github.io/2017/04/11/express-passport/" target="_blank" rel="noopener">https://andyyou.github.io/2017/04/11/express-passport/</a><br><a href="http://sj82516-blog.logdown.com/posts/1249667/nodejs-passportjs-cors-in-the-certification-process-and-development" target="_blank" rel="noopener">http://sj82516-blog.logdown.com/posts/1249667/nodejs-passportjs-cors-in-the-certification-process-and-development</a><br><a href="https://segmentfault.com/a/1190000005783325" target="_blank" rel="noopener">https://segmentfault.com/a/1190000005783325</a><br><a href="https://segmentfault.com/a/1190000005783306" target="_blank" rel="noopener">https://segmentfault.com/a/1190000005783306</a><br><a href="https://dotblogs.com.tw/daniel/2017/04/08/110915" target="_blank" rel="noopener">https://dotblogs.com.tw/daniel/2017/04/08/110915</a></p>
</div></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Nodejs/">Nodejs    </a><a class="post-meta__tags" href="/tags/Passportjs/">Passportjs    </a></div><div class="post_share"></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/05/06/cookie-session/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>關於 Cookie 與 Session</span></div></a></div><div class="next-post pull_right"><a href="/2020/04/20/vue-eslint-quotes-error/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>處理 vue eslint 錯誤(分號、雙引號、函式空格)</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相關推薦</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/05/07/nodejs-pagination/" title="Node.js 實作分頁"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-07</div><div class="relatedPosts_title">Node.js 實作分頁</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/21/nodejs-base/" title="Nodejs 簡單介紹"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-01-21</div><div class="relatedPosts_title">Nodejs 簡單介紹</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/15/nodejs-mongodb-restfulapi/" title="使用 Node.js 與 RESTful API 架構來串接 mongoDB 並部署到 Heroku"><img class="relatedPosts_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-15</div><div class="relatedPosts_title">使用 Node.js 與 RESTful API 架構來串接 mongoDB 並部署到 Heroku</div></div></a></div></div><div class="clear_both"></div></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By jerry wu</div><div class="framework-info"><span>Power by </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="閲讀模式"></i><i class="fa fa-plus" id="font_plus" title="放大字體"></i><i class="fa fa-minus" id="font_minus" title="縮小字體"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="簡繁轉換" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜間模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="設置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目錄" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到頂部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async></script></body></html>